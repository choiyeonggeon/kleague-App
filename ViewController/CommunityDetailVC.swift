//
//  CommunityDetailVC.swift
//  gugchugyeojido
//
//  Created by ÏµúÏòÅÍ±¥ on 6/17/25.
//

import UIKit
import SnapKit
import FirebaseAuth
import FirebaseFirestore

struct Comment {
    let id: String
    let postId: String
    let author: String
    let authorUid: String
    var text: String
    var isHidden: Bool
    let createdAt: Date
}

class CommunityDetailVC: UIViewController {
    
    var post: Post!
    private var comments: [Comment] = []
    private var badWords: [String] = []
    private var blockedUserIds: [String] = []
    private var currentUserNickname: String?
    var isAdmin = Auth.auth().currentUser?.uid == "TPW61yAyNhZ3Ee3CvhO2xsdmGej1"
    var isAuthor: Bool = false
    
    var currentUserUid: String? {
        return Auth.auth().currentUser?.uid
    }
    
    private let titleLabel = UILabel()
    private let contentLabel = UILabel()
    private let authorLabel = UILabel()
    private var likeButton = UIButton()
    private var dislikeButton = UIButton()
    private let commentField = UITextField()
    private let commentButton = UIButton(type: .system)
    private let commentTableView = UITableView()
    
    private let editButton = UIButton(type: .system)
    private let deletButton = UIButton(type: .system)
    
    private var currentUserName: String {
        Auth.auth().currentUser?.email ?? "ÏùµÎ™Ö"
    }
    
    init(post: Post) {
        self.post = post
        super.init(nibName: nil, bundle: nil)
    }
    required init?(coder: NSCoder) { fatalError("init(coder:) has not been implemented") }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .white
        setupDetailUI()
        checkIfCurrentUserIsAdmin()
        
        // 1. Ï¥àÍ∏∞ ÏÉÅÌÉú: Î≤ÑÌäº Î™®Îëê Ïà®ÍπÄ
        //        editButton.isHidden = true
        //        deletButton.isHidden = true
        
        // 2. ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∂àÎü¨ÏôÄÏÑú UI ÏóÖÎç∞Ïù¥Ìä∏
        loadUserInfo()
        
        fetchBadWords { [weak self] words in
            guard let self = self else { return }
            self.badWords = words
            self.fetchBlockedUsers {
                self.loadComments()
            }
        }
        
        fetchBlockedUsers { [weak self] in
            guard let self = self else { return }
            
            if self.blockedUserIds.contains(self.post.authorUid) {
                self.showAlert(title: "Ï∞®Îã®Îêú ÏÇ¨Ïö©Ïûê", message: "Ï∞®Îã®Ìïú ÏÇ¨Ïö©ÏûêÏùò Í≤åÏãúÍ∏ÄÏûÖÎãàÎã§.") {
                    self.navigationController?.popViewController(animated: true)
                }
                return
            }
            
            self.loadUserInfo()
            self.loadComments()
            self.fetchLatestPostInfo()
            self.fetchCurrentUserNickname()
        }
        
        if Auth.auth().currentUser?.uid != post.authorUid {
            editButton.isHidden = true
            deletButton.isHidden = true
        }
        
        commentTableView.delegate = self
        commentTableView.dataSource = self
        
        if let uid = Auth.auth().currentUser?.uid, uid != post.authorUid {
            navigationItem.rightBarButtonItem = UIBarButtonItem(
                image: UIImage(systemName: "ellipsis.circle"),
                style: .plain,
                target: self,
                action: #selector(didTapMoreButton)
            )
        }
        
        if let currentUid = Auth.auth().currentUser?.uid, currentUid != post.authorUid {
            navigationItem.rightBarButtonItem = UIBarButtonItem(image: UIImage(systemName: "ellipsis.circle"), style: .plain, target: self, action: #selector(didTapMoreButton))
        } else {
            navigationItem.rightBarButtonItem = nil
        }
        
        editButton.isHidden = true
        deletButton.isHidden = true
        navigationItem.leftBarButtonItem = nil
        
        commentTableView.rowHeight = UITableView.automaticDimension
        commentTableView.estimatedRowHeight = 100
        
        if let currentUid = Auth.auth().currentUser?.uid, currentUid != post.authorUid {
            navigationItem.rightBarButtonItem = UIBarButtonItem(
                image: UIImage(systemName: "ellipsis.circle"),
                style: .plain,
                target: self,
                action: #selector(didTapMoreButton)
            )
        } else {
            navigationItem.rightBarButtonItem = nil
        }
        
        let tapGesture = UITapGestureRecognizer(target: self, action: #selector(dismissKeyboard))
        view.addGestureRecognizer(tapGesture)
    }
    
    private func checkIfCurrentUserIsAdmin() {
        guard let uid = Auth.auth().currentUser?.uid else { return }
        let userRef = Firestore.firestore().collection("users").document(uid)
        userRef.getDocument { [weak self] snapshot, error in
            guard let data = snapshot?.data(), error == nil else { return }
            self?.isAdmin = (data["role"] as? String) == "admin"
        }
    }
    
    // MARK: - UI Setup
    
    private func setupDetailUI() {
        title = "Í∏Ä ÏÉÅÏÑ∏"
        
        titleLabel.text = post.title
        titleLabel.font = .boldSystemFont(ofSize: 24)
        
        contentLabel.text = post.preview
        contentLabel.numberOfLines = 0
        
        authorLabel.text = "Í∏ÄÏì¥Ïù¥: \(post.author)"
        authorLabel.font = .systemFont(ofSize: 14)
        authorLabel.textColor = .gray
        
        likeButton.setTitle("üëç \(post.likes)", for: .normal)
        likeButton.addTarget(self, action: #selector(didTapLike), for: .touchUpInside)
        
        dislikeButton.setTitle("üëé \(post.dislikes)", for: .normal)
        dislikeButton.setTitleColor(.systemRed, for: .normal)
        dislikeButton.addTarget(self, action: #selector(didTapDislike), for: .touchUpInside)
        
        commentField.placeholder = "ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!"
        commentField.borderStyle = .roundedRect
        
        commentButton.setTitle("ÏûëÏÑ±", for: .normal)
        commentButton.addTarget(self, action: #selector(didTapComment), for: .touchUpInside)
        
        editButton.setTitle("ÏàòÏ†ï", for: .normal)
        editButton.setTitleColor(.systemBlue, for: .normal)
        editButton.addTarget(self, action: #selector(didTapEdit), for: .touchUpInside)
        
        deletButton.setTitle("ÏÇ≠Ï†ú", for: .normal)
        deletButton.setTitleColor(.systemRed, for: .normal)
        deletButton.addTarget(self, action: #selector(didTapDelete), for: .touchUpInside)
        
        commentTableView.dataSource = self
        commentTableView.delegate = self
        commentTableView.register(CommentCell.self, forCellReuseIdentifier: CommentCell.identifier)
        
        [titleLabel, contentLabel, authorLabel, likeButton, dislikeButton, commentField, commentButton, commentTableView, editButton, deletButton].forEach {
            view.addSubview($0)
        }
        
        titleLabel.snp.makeConstraints {
            $0.top.equalTo(view.safeAreaLayoutGuide).offset(20)
            $0.leading.trailing.equalToSuperview().inset(20)
        }
        
        contentLabel.snp.makeConstraints {
            $0.top.equalTo(titleLabel.snp.bottom).offset(8)
            $0.leading.trailing.equalToSuperview().inset(16)
        }
        
        authorLabel.snp.makeConstraints {
            $0.top.equalTo(contentLabel.snp.bottom).offset(8)
            $0.leading.trailing.equalToSuperview().inset(16)
        }
        
        likeButton.snp.makeConstraints {
            $0.top.equalTo(authorLabel.snp.bottom).offset(8)
            $0.leading.equalToSuperview().inset(16)
        }
        
        dislikeButton.snp.makeConstraints {
            $0.centerY.equalTo(likeButton)
            $0.leading.equalTo(likeButton.snp.trailing).offset(20)
        }
        
        editButton.snp.remakeConstraints {
            $0.trailing.equalTo(deletButton.snp.leading).offset(-8)
            $0.centerY.equalTo(dislikeButton)
            $0.width.equalTo(60)
            $0.height.equalTo(30)
        }
        
        deletButton.snp.remakeConstraints {
            $0.trailing.equalToSuperview().inset(16)
            $0.centerY.equalTo(dislikeButton)
            $0.width.equalTo(60)
            $0.height.equalTo(30)
        }
        
        commentField.snp.makeConstraints {
            $0.top.equalTo(likeButton.snp.bottom).offset(20)
            $0.leading.equalToSuperview().inset(16)
            $0.trailing.equalTo(commentButton.snp.leading).offset(-8)
            $0.height.equalTo(40)
        }
        
        commentButton.snp.makeConstraints {
            $0.centerY.equalTo(commentField)
            $0.trailing.equalToSuperview().inset(16)
            $0.width.equalTo(60)
        }
        
        commentTableView.snp.makeConstraints {
            $0.top.equalTo(commentField.snp.bottom).offset(8)
            $0.leading.trailing.bottom.equalToSuperview()
        }
    }
    
    private func loadUserInfo() {
        guard let uid = Auth.auth().currentUser?.uid else {
            DispatchQueue.main.async {
                self.editButton.isHidden = true
                self.deletButton.isHidden = true
                self.navigationItem.leftBarButtonItem = nil
            }
            return
        }
        
        let userRef = Firestore.firestore().collection("users").document(uid)
        userRef.getDocument { snapshot, error in
            guard let data = snapshot?.data(), error == nil else { return }
            
            self.isAdmin = (data["role"] as? String) == "admin"
            
            DispatchQueue.main.async {
                let isAuthor = (uid == self.post.authorUid)
                
                // ÏûëÏÑ±ÏûêÍ±∞ÎÇò Í¥ÄÎ¶¨ÏûêÎ©¥ ÏàòÏ†ï/ÏÇ≠Ï†ú Î≤ÑÌäº Î≥¥ÏûÑ
                if isAuthor || self.isAdmin {
                    self.editButton.isHidden = false
                    self.deletButton.isHidden = false
                } else {
                    self.editButton.isHidden = true
                    self.deletButton.isHidden = true
                }
                
                self.commentTableView.reloadData()
            }
        }
    }
    
    // MARK: - ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Î∞è ÌïÑÌÑ∞ÎßÅ
    
    private func loadComments() {
        let ref = Firestore.firestore()
            .collection("posts")
            .document(post.id)
            .collection("comments")
            .order(by: "createdAt", descending: false)
        ref.getDocuments { [weak self] snapshot, error in
            guard let self = self else { return }
            if let error = error {
                print("ÎåìÍ∏Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: \(error.localizedDescription)")
                return
            }
            
            var fetchedComments: [Comment] = []
            snapshot?.documents.forEach { doc in
                let data = doc.data()
                guard
                    let author = data["author"] as? String,
                    let authorUid = data["authorUid"] as? String,
                    let text = data["text"] as? String,
                    let timestamp = data["createdAt"] as? Timestamp,
                    let isHidden = data["isHidden"] as? Bool,
                    isHidden == false
                else { return }
                
                // Ï∞®Îã®Îêú Ïú†Ï†Ä ÎåìÍ∏Ä ÌïÑÌÑ∞ÎßÅ
                if self.blockedUserIds.contains(authorUid) {
                    return
                }
                
                let comment = Comment(
                    id: doc.documentID,
                    postId: self.post.id,
                    author: author,
                    authorUid: authorUid,
                    text: text,
                    isHidden: false,
                    createdAt: timestamp.dateValue()
                )
                fetchedComments.append(comment)
            }
            
            self.comments = fetchedComments
            DispatchQueue.main.async {
                self.commentTableView.reloadData()
            }
        }
    }
    
    // MARK: - Ï∞®Îã® Ïú†Ï†Ä Î∂àÎü¨Ïò§Í∏∞
    
    private func fetchBlockedUsers(completion: @escaping () -> Void) {
        guard let currentUid = Auth.auth().currentUser?.uid else {
            blockedUserIds = []
            completion()
            return
        }
        Firestore.firestore()
            .collection("users")
            .document(currentUid)
            .collection("blockedUsers")
            .getDocuments { [weak self] snapshot, error in
                if let error = error {
                    print("Ï∞®Îã® Ïú†Ï†Ä Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: \(error)")
                    self?.blockedUserIds = []
                    completion()
                    return
                }
                self?.blockedUserIds = snapshot?.documents.map { $0.documentID } ?? []
                completion()
            }
    }
    
    func blockUser(uid: String, completion: @escaping () -> Void = {}) {
        guard let currentUid = Auth.auth().currentUser?.uid else { return }
        Firestore.firestore()
            .collection("users")
            .document(currentUid)
            .collection("blockedUsers")
            .document(uid)
            .setData(["blockedAt": Timestamp(date: Date())]) { [weak self] error in
                if let error = error {
                    print("Ïú†Ï†Ä Ï∞®Îã® Ïã§Ìå®: \(error.localizedDescription)")
                } else {
                    print("Ïú†Ï†Ä Ï∞®Îã® ÏÑ±Í≥µ")
                    self?.fetchBlockedUsers {
                        self?.loadComments()
                        completion()
                    }
                    self?.showAlert(title: "Ï∞®Îã® ÏôÑÎ£å", message: "Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÏùò ÎåìÍ∏Ä ÎòêÎäî Í≤åÏãúÍ∏ÄÏù¥ Ïà®Í≤®ÏßëÎãàÎã§.")
                }
            }
    }
    
    func unblockUser(uid: String, completion: @escaping () -> Void = {}) {
        guard let currentUid = Auth.auth().currentUser?.uid else { return }
        Firestore.firestore()
            .collection("users")
            .document(currentUid)
            .collection("blockedUsers")
            .document(uid)
            .delete { [weak self] error in
                if let error = error {
                    print("Ï∞®Îã® Ìï¥Ï†ú Ïã§Ìå®: \(error.localizedDescription)")
                } else {
                    print("Ï∞®Îã® Ìï¥Ï†ú ÏÑ±Í≥µ")
                    self?.fetchBlockedUsers {
                        self?.loadComments()
                        completion()
                    }
                    self?.showAlert(title: "Ï∞®Îã® Ìï¥Ï†ú", message: "Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÏùò ÎåìÍ∏ÄÏù¥ Îã§Ïãú ÌëúÏãúÎê©ÎãàÎã§.")
                }
            }
    }
    
    // MARK: - Í∏àÏßÄÏñ¥ Î∂àÎü¨Ïò§Í∏∞
    
    func fetchBadWords(completion: @escaping ([String]) -> Void) {
        Firestore.firestore().collection("badWords").getDocuments { snapshot, error in
            if let error = error {
                print("Í∏àÏßÄÏñ¥ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", error.localizedDescription)
                completion([])
                return
            }
            let words = snapshot?.documents.compactMap { $0.data()["word"] as? String } ?? []
            completion(words)
        }
    }
    
    func containsBadWord(_ text: String, badwords: [String]) -> Bool {
        let loweredText = text.lowercased()
        for word in badwords {
            if loweredText.contains(word.lowercased()) {
                return true
            }
        }
        return false
    }
    
    // MARK: - ÎåìÍ∏Ä ÏûëÏÑ±
    
    @objc private func didTapComment() {
        guard Auth.auth().currentUser != nil else {
            let alert = UIAlertController(title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî", message: "ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ïïº Ìï©ÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            present(alert, animated: true)
            return
        }
        
        guard let text = commentField.text, !text.isEmpty else {
            let alert = UIAlertController(title: "ÏûÖÎ†• Ïò§Î•ò", message: "Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            present(alert, animated: true)
            return
        }
        
        if containsBadWord(text, badwords: badWords) {
            let alert = UIAlertController(title: "Í∏àÏßÄÏñ¥ Ìè¨Ìï®", message: "ÎåìÍ∏ÄÏóê Í∏àÏßÄÏñ¥Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            present(alert, animated: true)
            return
        }
        
        let authorName = self.currentUserNickname ?? self.currentUserName
        
        let newComment = Comment(
            id: UUID().uuidString,
            postId: post.id,
            author: authorName,
            authorUid: Auth.auth().currentUser?.uid ?? "",
            text: text,
            isHidden: false,
            createdAt: Date()
        )
        
        comments.append(newComment)
        commentField.text = ""
        commentTableView.reloadData()
        
        let postRef = Firestore.firestore().collection("posts").document(post.id)
        postRef.collection("comments").addDocument(data: [
            "author": authorName,
            "authorUid": Auth.auth().currentUser?.uid ?? "",
            "text": text,
            "createdAt": Timestamp(date: newComment.createdAt),
            "isHidden": false,
            "reportCount": 0
        ]) { error in
            if let error = error {
                print("ÎåìÍ∏Ä Ï†ÄÏû• Ïã§Ìå®: \(error.localizedDescription)")
                return
            }
            DispatchQueue.main.async {
                self.commentField.text = ""
                self.commentTableView.reloadData()
            }
            postRef.updateData(["commentsCount": FieldValue.increment(Int64(1))])
        }
    }
    
    // MARK: - ÏµúÏã† Í≤åÏãúÍ∏Ä Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
    
    private func fetchLatestPostInfo() {
        let ref = Firestore.firestore().collection("posts").document(post.id)
        ref.getDocument { snapshot, error in
            guard let data = snapshot?.data() else { return }
            let latestLikes = data["likes"] as? Int ?? 0
            let latestDislikes = data["dislikes"] as? Int ?? 0
            self.post.likes = latestLikes
            self.post.dislikes = latestDislikes
            self.likeButton.setTitle("üëç \(latestLikes)", for: .normal)
            self.dislikeButton.setTitle("üëé \(latestDislikes)", for: .normal)
        }
    }
    
    // MARK: - Ïú†Ï†Ä ÎãâÎÑ§ÏûÑ Î∂àÎü¨Ïò§Í∏∞
    
    private func fetchCurrentUserNickname() {
        guard let uid = Auth.auth().currentUser?.uid else { return }
        Firestore.firestore().collection("users").document(uid).getDocument { snapshot, error in
            if let data = snapshot?.data(), let nickname = data["nickname"] as? String {
                self.currentUserNickname = nickname
            } else {
                self.currentUserNickname = "ÏùµÎ™Ö"
            }
        }
    }
    
    // MARK: - Ï¢ãÏïÑÏöî / Ïã´Ïñ¥Ïöî Ïï°ÏÖò
    
    @objc private func didTapLike() {
        guard let uid = Auth.auth().currentUser?.uid else {
            let alert = UIAlertController(title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî", message: "Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•¥Î†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ïïº Ìï©ÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            self.present(alert, animated: true)
            return
        }
        
        let ref = Firestore.firestore().collection("posts").document(post.id)
        ref.getDocument { snapshot, error in
            guard let data = snapshot?.data() else { return }
            var likedUserIds = data["likedUserIds"] as? [String] ?? []
            
            if likedUserIds.contains(uid) {
                let alert = UIAlertController(title: "ÏïåÎ¶º", message: "Ïù¥ÎØ∏ Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•¥ÏÖ®ÏäµÎãàÎã§.", preferredStyle: .alert)
                alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
                self.present(alert, animated: true)
                return
            }
            
            likedUserIds.append(uid)
            ref.updateData([
                "likes": FieldValue.increment(Int64(1)),
                "likedUserIds": likedUserIds
            ]) { error in
                if error == nil {
                    self.post.likes += 1
                    self.likeButton.setTitle("üëç \(self.post.likes)", for: .normal)
                }
            }
        }
    }
    
    @objc private func didTapDislike() {
        guard let uid = Auth.auth().currentUser?.uid else {
            let alert = UIAlertController(title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî", message: "Ïã´Ïñ¥ÏöîÎ•º ÎàÑÎ•¥Î†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ïïº Ìï©ÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            self.present(alert, animated: true)
            return
        }
        
        let ref = Firestore.firestore().collection("posts").document(post.id)
        ref.getDocument { snapshot, error in
            guard let data = snapshot?.data() else { return }
            var dislikedUserIds = data["dislikedUserIds"] as? [String] ?? []
            
            if dislikedUserIds.contains(uid) {
                let alert = UIAlertController(title: "ÏïåÎ¶º", message: "Ïù¥ÎØ∏ Ïã´Ïñ¥ÏöîÎ•º ÎàÑÎ•¥ÏÖ®ÏäµÎãàÎã§.", preferredStyle: .alert)
                alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
                self.present(alert, animated: true)
                return
            }
            
            dislikedUserIds.append(uid)
            ref.updateData([
                "dislikes": FieldValue.increment(Int64(1)),
                "dislikedUserIds": dislikedUserIds
            ]) { error in
                if error == nil {
                    self.post.dislikes += 1
                    self.dislikeButton.setTitle("üëé \(self.post.dislikes)", for: .normal)
                }
            }
        }
    }
    
    // MARK: - Í∏Ä ÏàòÏ†ï / ÏÇ≠Ï†ú
    
    @objc private func didTapDelete() {
        let alert = UIAlertController(title: "Í∏Ä ÏÇ≠Ï†ú", message: "Ïù¥ Í∏ÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?", preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        alert.addAction(UIAlertAction(title: "ÏÇ≠Ï†ú", style: .destructive, handler: { _ in
            Firestore.firestore().collection("posts").document(self.post.id).delete { error in
                if let error = error {
                    print("ÏÇ≠Ï†ú Ïã§Ìå® \(error.localizedDescription)")
                } else {
                    self.navigationController?.popViewController(animated: true)
                }
            }
        }))
        present(alert, animated: true)
    }
    
    @objc private func didTapEdit() {
        let writeVC = CommunityWriteVC()
        writeVC.editingPost = post
        navigationController?.pushViewController(writeVC, animated: true)
    }
    
    @objc private func dismissKeyboard() {
        view.endEditing(true)
    }
    
    // MARK: - Ïã†Í≥†
    
    @objc private func didTapReportPost() {
        guard Auth.auth().currentUser != nil else {
            let alert = UIAlertController(title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî", message: "Ïã†Í≥†ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ïïº Ìï©ÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            present(alert, animated: true)
            return
        }
        
        let alert = UIAlertController(title: "Ïã†Í≥† ÏÇ¨Ïú† ÏÑ†ÌÉù", message: nil, preferredStyle: .actionSheet)
        let reasons = ["ÏöïÏÑ§ Î∞è ÎπÑÎ∞©", "Ïä§Ìå∏", "ÏùåÎûÄÎ¨º", "Í∏∞ÌÉÄ"]
        for reason in reasons {
            alert.addAction(UIAlertAction(title: reason, style: .default, handler: { _ in
                self.reportPost(reason: reason)
            }))
        }
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        
        if let popover = alert.popoverPresentationController {
            if let barButtonItem = self.navigationItem.rightBarButtonItem {
                popover.barButtonItem = barButtonItem
            } else {
                popover.sourceView = self.view
                popover.sourceRect = CGRect(
                    x: self.view.bounds.midX,
                    y: self.view.bounds.midY,
                    width: 0,
                    height: 0)
            }
        }
        present(alert, animated: true)
    }
    
    // Ïã†Í≥† Ï≤òÎ¶¨ Ïã§Ï†ú Î°úÏßÅ (ÏòàÏãú)
    func reportPost(reason: String) {
        guard let currentUser = Auth.auth().currentUser else { return }
        
        let firestore = Firestore.firestore()
        
        // Ï§ëÎ≥µ Ïã†Í≥† Î∞©ÏßÄ
        firestore.collection("reports")
            .whereField("postId", isEqualTo: post.id)
            .whereField("reportedByUid", isEqualTo: currentUser.uid)
            .whereField("resolved", isEqualTo: false)
            .whereField("isHidden", isEqualTo: false)
            .getDocuments { snapshot, error in
                if let error = error {
                    print("Ïã†Í≥† Ï§ëÎ≥µ Í≤ÄÏÇ¨ Ïã§Ìå®: \(error.localizedDescription)")
                    return
                }
                
                // Ïù¥ÎØ∏ Ïã†Í≥†Ìïú Í≤ΩÏö∞
                if let documents = snapshot?.documents, !documents.isEmpty {
                    self.showAlert(title: "Ïù¥ÎØ∏ Ïã†Í≥†Ìï®", message: "Ïù¥ÎØ∏ Ïù¥ Í≤åÏãúÍ∏ÄÏùÑ Ïã†Í≥†ÌïòÏÖ®ÏäµÎãàÎã§.")
                    return
                }
                
                // Ïã†Í≥† Îì±Î°ù
                let reportData: [String: Any] = [
                    "postId": self.post.id,
                    "reportedUserId": self.post.authorUid,
                    "reportedByUid": currentUser.uid,
                    "reportedBy": currentUser.email ?? "ÏùµÎ™Ö",
                    "reason": reason,
                    "reportedAt": Timestamp(date: Date()),
                    "reportCount": 0,
                    "isHidden": false,
                    "resolved": false
                ]
                
                let reportRef = firestore.collection("reports").document()
                reportRef.setData(reportData) { error in
                    DispatchQueue.main.async {
                        if let error = error {
                            self.showAlert(title: "Ïã†Í≥† Ïã§Ìå®", message: error.localizedDescription)
                        } else {
                            self.showAlert(title: "Ïã†Í≥† ÏôÑÎ£å", message: "Ïã†Í≥†Í∞Ä Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§. 24ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïóê Í¥ÄÎ¶¨ÏûêÏóê ÏùòÌï¥ Í≤ÄÌÜ† ÌõÑ Ï°∞ÏπòÎê† ÏòàÏ†ïÏûÖÎãàÎã§.")
                        }
                    }
                }
            }
    }
    
    func reportComment(comment: Comment) {
        guard Auth.auth().currentUser != nil else {
            let alert = UIAlertController(title: "Î°úÍ∑∏Ïù∏ ÌïÑÏöî", message: "Ïã†Í≥†ÌïòÎ†§Î©¥ Î°úÍ∑∏Ïù∏Ìï¥Ïïº Ìï©ÎãàÎã§.", preferredStyle: .alert)
            alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
            present(alert, animated: true)
            return
        }
        
        let alert = UIAlertController(title: "ÎåìÍ∏Ä Ïã†Í≥† ÏÇ¨Ïú† ÏÑ†ÌÉù", message: nil, preferredStyle: .actionSheet)
        let reasons = ["ÏöïÏÑ§ Î∞è ÎπÑÎ∞©", "Ïä§Ìå∏", "ÏùåÎûÄÎ¨º", "Í∏∞ÌÉÄ"]
        for reason in reasons {
            alert.addAction(UIAlertAction(title: reason, style: .default, handler: { _ in
                self.submitCommentReport(comment: comment, reason: reason)
            }))
        }
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        
        if let popover = alert.popoverPresentationController {
            popover.sourceView = self.view
            popover.sourceRect = CGRect(x: self.view.bounds.midX, y: self.view.bounds.midY, width: 0, height: 0)
        }
        present(alert, animated: true)
    }
    
    private func submitCommentReport(comment: Comment, reason: String) {
        guard let currentUser = Auth.auth().currentUser else { return }
        
        let firestore = Firestore.firestore()
        
        // Ï§ëÎ≥µ Ïã†Í≥† Í≤ÄÏÇ¨
        firestore.collection("reports")
            .whereField("commentId", isEqualTo: comment.id)
            .whereField("reportedByUid", isEqualTo: currentUser.uid)
            .whereField("resolved", isEqualTo: false)
            .whereField("isHidden", isEqualTo: false)
            .getDocuments { snapshot, error in
                if let error = error {
                    print("ÎåìÍ∏Ä Ïã†Í≥† Ï§ëÎ≥µ Í≤ÄÏÇ¨ Ïã§Ìå®: \(error.localizedDescription)")
                    return
                }
                
                if let documents = snapshot?.documents, !documents.isEmpty {
                    self.showAlert(title: "Ïù¥ÎØ∏ Ïã†Í≥†Ìï®", message: "Ïù¥ÎØ∏ Ïù¥ ÎåìÍ∏ÄÏùÑ Ïã†Í≥†ÌïòÏÖ®ÏäµÎãàÎã§.")
                    return
                }
                
                let reportData: [String: Any] = [
                    "commentId": comment.id,
                    "postId": comment.postId,
                    "reportedUserId": comment.authorUid,
                    "reportedByUid": currentUser.uid,
                    "reportedBy": currentUser.email ?? "ÏùµÎ™Ö",
                    "reason": reason,
                    "reportedAt": Timestamp(date: Date()),
                    "reportCount": 0,
                    "isHidden": false,
                    "resolved": false
                ]
                
                firestore.collection("reports").addDocument(data: reportData) { error in
                    DispatchQueue.main.async {
                        if let error = error {
                            self.showAlert(title: "Ïã†Í≥† Ïã§Ìå®", message: error.localizedDescription)
                        } else {
                            self.showAlert(title: "Ïã†Í≥† ÏôÑÎ£å", message: "ÎåìÍ∏Ä Ïã†Í≥†Í∞Ä Ï†ëÏàòÎêòÏóàÏäµÎãàÎã§. 24ÏãúÍ∞Ñ Ïù¥ÎÇ¥Ïóê Í≤ÄÌÜ† ÌõÑ Ï°∞ÏπòÎê† ÏòàÏ†ïÏûÖÎãàÎã§.")
                        }
                    }
                }
            }
    }
    
    private func showAlert(title: String, message: String) {
        let alert = UIAlertController(title: title, message: message, preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: .default))
        present(alert, animated: true)
    }
}

// MARK: - UITableView Delegate & DataSource

extension CommunityDetailVC: UITableViewDelegate, UITableViewDataSource {
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        comments.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
        guard let cell = tableView.dequeueReusableCell(withIdentifier: CommentCell.identifier, for: indexPath) as? CommentCell else {
            return UITableViewCell()
        }
        
        let comment = comments[indexPath.row]
        let isBlocked = blockedUserIds.contains(comment.authorUid)
        
        cell.configure(
            with: comment,
            isBlocked: blockedUserIds.contains(comment.authorUid),
            isAdmin: isAdmin,
            isAuthor: comment.authorUid == Auth.auth().currentUser?.uid
        )
        
        // Ï∞®Îã® / Ï∞®Îã® Ìï¥Ï†ú Î≤ÑÌäº Ïï°ÏÖò
        cell.blockAction = { [weak self] in
            guard let self = self else { return }
            if isBlocked {
                self.unblockUser(uid: comment.authorUid)
            } else {
                self.blockUser(uid: comment.authorUid)
            }
        }
        
        cell.reportAction = { [weak self] in
            guard let self = self else { return }
            self.reportComment(comment: comment)
        }
        
        cell.deleteAction = { [weak self] in
            guard let self = self else { return }
            
            // üîê ÏÇ≠Ï†ú Í∂åÌïú ÌôïÏù∏: ÏûëÏÑ±Ïûê Î≥∏Ïù∏ ÎòêÎäî Í¥ÄÎ¶¨Ïûê
            guard self.isAdmin || comment.authorUid == self.currentUserUid else {
                self.showAlert(title: "Í∂åÌïú ÏóÜÏùå", message: "ÎåìÍ∏ÄÏùÑ ÏÇ≠Ï†úÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.")
                return
            }
            
            let commentRef = Firestore.firestore()
                .collection("posts")
                .document(self.post.id)
                .collection("comments")
                .document(comment.id)
            
            let postRef = Firestore.firestore().collection("posts").document(self.post.id)
            
            commentRef.delete { error in
                if let error = error {
                    print("ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®: \(error.localizedDescription)")
                    return
                }
                
                // ÎåìÍ∏Ä Ïàò Í∞êÏÜå Ï≤òÎ¶¨
                postRef.updateData([
                    "commentsCount": FieldValue.increment(Int64(-1))
                ]) { updateError in
                    if let updateError = updateError {
                        print("ÎåìÍ∏Ä Ïàò Í∞êÏÜå Ïã§Ìå®: \(updateError.localizedDescription)")
                    }
                }
                
                self.loadComments()
            }
        }
        
        cell.hideAction = { [weak self] in
            guard let self = self else { return }
            Firestore.firestore()
                .collection("posts")
                .document(post.id)
                .collection("comments")
                .document(comment.id)
                .updateData(["isHidden": true]) { error in
                    if error == nil {
                        self.loadComments()
                    }
                }
        }
        
        cell.editAction = { [weak self] in
            guard let self = self else { return }
            let alert = UIAlertController(title: "ÎåìÍ∏Ä ÏàòÏ†ï", message: nil, preferredStyle: .alert)
            alert.addTextField { $0.text = comment.text }
            alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
            alert.addAction(UIAlertAction(title: "Ï†ÄÏû•", style: .default, handler: { _ in
                guard let newText = alert.textFields?.first?.text, !newText.isEmpty else { return }
                
                if self.containsBadWord(newText, badwords: self.badWords) {
                    self.showAlert(title: "Í∏àÏßÄÏñ¥ Ìè¨Ìï®", message: "Í∏àÏßÄÏñ¥Í∞Ä Ìè¨Ìï®Îêú ÎåìÍ∏ÄÏùÄ ÏûëÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§.")
                    return
                }
                
                Firestore.firestore()
                    .collection("posts")
                    .document(comment.postId)
                    .collection("comments")
                    .document(comment.id)
                    .updateData([
                        "text": newText
                    ]) { error in
                        if let error = error {
                            print("ÎåìÍ∏Ä ÏàòÏ†ï Ïã§Ìå®: \(error.localizedDescription)")
                        } else {
                            self.loadComments()
                        }
                    }
            }))
            self.present(alert, animated: true)
        }
        
        return cell
    }
    
    @objc private func didTapHidePost() {
        let alert = UIAlertController(title: "Í≤åÏãúÍ∏Ä Ïà®ÍπÄ", message: "Ïù¥ Í≤åÏãúÍ∏ÄÏùÑ ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïà®Í∏∞ÏãúÍ≤†ÏäµÎãàÍπå?", preferredStyle: .alert)
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        alert.addAction(UIAlertAction(title: "Ïà®ÍπÄ", style: .destructive, handler: { _ in
            Firestore.firestore().collection("posts").document(self.post.id).updateData(["isHidden": true]) { error in
                if let error = error {
                    self.showAlert(title: "Ïã§Ìå®", message: error.localizedDescription)
                } else {
                    self.showAlert(title: "ÏôÑÎ£å", message: "Í≤åÏãúÍ∏ÄÏù¥ Ïà®ÍπÄ Ï≤òÎ¶¨ÎêòÏóàÏäµÎãàÎã§.")
                    self.navigationController?.popViewController(animated: true)
                }
            }
        }))
        present(alert, animated: true)
    }
    
    @objc private func didTapMoreButton() {
        let alert = UIAlertController(title: nil, message: nil, preferredStyle: .actionSheet)
        
        alert.addAction(UIAlertAction(title: "Ïã†Í≥†ÌïòÍ∏∞", style: .destructive, handler: { _ in
            self.didTapReportPost()
        }))
        
        alert.addAction(UIAlertAction(title: "ÏûëÏÑ±Ïûê Ï∞®Îã®", style: .destructive, handler: { _ in
            self.blockUser(uid: self.post.authorUid) {
                self.showAlert(title: "Ï∞®Îã® ÏôÑÎ£å", message: "Ìï¥Îãπ ÏÇ¨Ïö©ÏûêÏùò Í∏ÄÏù¥ Ïà®Í≤®ÏßëÎãàÎã§.")
                self.navigationController?.popViewController(animated: true)
            }
        }))
        
        alert.addAction(UIAlertAction(title: "Ï∑®ÏÜå", style: .cancel))
        
        if let currentUid = Auth.auth().currentUser?.uid,
           currentUid != post.authorUid {
            navigationItem.rightBarButtonItem = UIBarButtonItem(
                image: UIImage(systemName: "ellipsis.circle"),
                style: .plain,
                target: self,
                action: #selector(didTapMoreButton)
            )
        }
        
        if let popover = alert.popoverPresentationController {
            popover.barButtonItem = self.navigationItem.rightBarButtonItem
        }
        present(alert, animated: true)
    }
}
